import edu.sc.seis.launch4j.tasks.Launch4jLibraryTask

buildscript {
    repositories {
        maven { url "https://plugins.gradle.org/m2/" }
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:2.6.8")
    }
}

apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

ext['jna.version'] = '5.4.0'


dependencies {
    implementation project(':sirius_rest_service')
    implementation 'org.junit.jupiter:junit-jupiter:5.8.2'
    testImplementation project(':sirius_dist').sourceSets.test.output //needed for the TestLocal tests
}

configurations.all {
    //replaced by log4j-over-slf4j
    it.exclude group: "log4j", module: "log4j"
    //replaced by jcl-over-slf4j
    it.exclude group: "commons-logging", module: "commons-logging"
}
//mainClassName = 'org.springframework.boot.loader.PropertiesLauncher'
mainClassName = 'org.springframework.boot.loader.JarLauncher'


/*################### Jar build Stuff ################### */

launch4j {
    mainClassName = project.mainClassName
    jar = getLibraryDir() + "\\" + getRootProject().getChildProjects().get('sirius_rest_service').tasks.getByName('bootJar').outputs.files.singleFile.getName()
}

//additional GUI win launcher
task createGuiExe(type: Launch4jLibraryTask) {
    outfile = 'sirius-gui.exe'
    fileDescription = 'SIRIUS graphical user interface'
    headerType = "gui"
    cmdLine = "gui"
}
createGuiExe.dependsOn 'launch4j'


distImage {
    dependsOn  getRootProject().getChildProjects().get('sirius_rest_service').tasks.getByName('bootJar')

    if (includeJreFX){
        dependsOn getParent().tasks.getByName('extractRuntimeImageFX')
    }else {
        mkdir(runtimeImageDirectory = getParent().tasks.getByName('extractRuntimeImageFX').outputs.files.singleFile)
    }
    runtimeImageDirectory = getParent().tasks.getByName('extractRuntimeImageFX').outputs.files.singleFile

    inputDir = getRootProject().getChildProjects().get('sirius_rest_service').tasks.getByName('bootJar').outputs.files.singleFile.toPath().getParent().toFile()
    imageName = 'sirius'
    mainClass = mainClassName
    mainJarName = getRootProject().getChildProjects().get('sirius_rest_service').tasks.getByName('bootJar').outputs.files.singleFile.getName()
    winConsole = true
    macPackageName = 'SIRIUS-service'
    if (siriusTargetPlatform.isWin()) { //HACK additional windows launchers are imported from launch4j, this is just fake to register it for the start menu. must be a valid path but file must not exists
        launchers = ["sirius-gui": "${createGuiExe.outfile}"]
    }
}
distImage.dependsOn getRootProject().getChildProjects().get('sirius_rest_service').tasks.getByName('bootJar')
distribution.dependsOn 'distImageZip'
distribution.dependsOn 'createChecksums'

publishing {
    publications {
        siriusMS(org.gradle.api.publish.maven.MavenPublication) {
            artifactId = "$name"
            groupId = "$group"
            artifact source: "${distImage.getImageDir().absolutePath}.zip", classifier: "$osName-service", extension: 'zip'
//            if (!siriusTargetPlatform.isLinux())
//                artifact source: "${siriusTargetPlatform.isMac() ? distImage.getImageDir().absolutePath.replace('.app', installerAppendix) : distImage.getImageDir().absolutePath + installerAppendix}", classifier: "$osName-headless", extension: installerNameType
        }
        sirius(org.gradle.api.publish.maven.MavenPublication) {
            artifactId = "$name"
            groupId = "$group"
            artifact source: "${distImage.getImageDir().absolutePath}.zip", classifier: "$osName-service", extension: 'zip'
            artifact source: "${distImage.getImageDir().absolutePath}.zip.sha256", classifier: "$osName-service", extension: 'zip.sha256'
            /*if (!siriusTargetPlatform.isLinux()) {
                artifact source: "${siriusTargetPlatform.isMac() ? distImage.getImageDir().absolutePath.replace('.app', installerAppendix) : distImage.getImageDir().absolutePath + installerAppendix}", classifier: "$osName-headless", extension: installerNameType
                artifact source: "${siriusTargetPlatform.isMac() ? distImage.getImageDir().absolutePath.replace('.app', installerAppendix) : distImage.getImageDir().absolutePath + installerAppendix}.sha256", classifier: "$osName-headless", extension: "${installerNameType}.sha256"
            }*/
        }
    }
}
publishSiriusPublicationToMavenLocal.dependsOn 'distribution'
publishSiriusMSPublicationToMavenLocal.dependsOn 'distribution'
